pipeline{
	agent any
	environment {
        registry = "thunderkill/supersimpledockerwebsitetest"
	}
	stages {
		stage('Build') {
            steps {
                sh "docker build -t $registry:latest ."
            }
		}
        stage('Deploy our image') { 
            steps { 
                withCredentials([usernamePassword(credentialsId: 'docker-credentials', usernameVariable: 'HUB_USER', passwordVariable: 'HUB_TOKEN')]) {                      
                    sh '''
                        docker login -u $HUB_USER -p $HUB_TOKEN 
                        docker image tag $registry:latest $registry:latest
                        docker image push $registry:latest
                    '''
                }
            }
        }
	}

	post {
		always {
            sh "docker rmi $registry:latest"
		}
	}
}